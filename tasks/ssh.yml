- name: Ensure .ssh directory exists.
  file:
    dest: "{{ lookup('env', 'HOME') }}/.ssh"
    mode: 0700
    state: directory
  become: false
  tags:
    - dotfiles
    - install
    - ssh

- name: Install ssh private keys (with decryption)
  copy:
    src: "{{ item.source }}"
    dest: "{{ item.dest }}"
    mode: 0600
    decrypt: yes
  become: false
  loop: "{{ ssh_keys }}"
  tags:
    - dotfiles
    - install
    - ssh

- name: Install ssh public keys
  copy:
    src: "{{ item.source }}.pub"
    dest: "{{ item.dest }}.pub"
    mode: 0644
    decrypt: yes
  become: false
  loop: "{{ ssh_keys }}"
  tags:
    - dotfiles
    - install
    - ssh

- name: Gather passwd entries for SSH key propagation
  ansible.builtin.getent:
    database: passwd
  become: true
  tags:
    - dotfiles
    - install
    - ssh

- name: Collect local public keys
  ansible.builtin.set_fact:
    local_public_keys: "{{ lookup('fileglob', lookup('env', 'HOME') + '/.ssh/*.pub', wantlist=True) }}"
  tags:
    - dotfiles
    - install
    - ssh

- name: Build list of eligible users for SSH keys
  ansible.builtin.set_fact:
    eligible_users: "{{ (eligible_users | default([])) + [ item ] }}"
  loop: "{{ getent_passwd | dict2items }}"
  when:
    - (item.value[1] | int) >= 1000
    - item.value[5] not in ['/usr/sbin/nologin', '/bin/false']
  tags:
    - dotfiles
    - install
    - ssh

- name: Ensure per-user .ssh directories exist
  ansible.builtin.file:
    path: "{{ item.value[4] }}/.ssh"
    state: directory
    mode: '0700'
    owner: "{{ item.key }}"
    group: "{{ item.key }}"
  loop: "{{ eligible_users | default([]) }}"
  become: true
  when: (eligible_users | default([])) | length > 0
  tags:
    - dotfiles
    - install
    - ssh

- name: Fetch GitHub host key
  ansible.builtin.command: ssh-keyscan -H github.com
  register: github_known_host
  changed_when: false
  tags:
    - dotfiles
    - install
    - ssh

- name: Add GitHub to known_hosts for all users
  ansible.builtin.known_hosts:
    path: "{{ item.value[4] }}/.ssh/known_hosts"
    name: github.com
    key: "{{ github_known_host.stdout }}"
    state: present
  loop: "{{ eligible_users | default([]) }}"
  become: true
  when:
    - (eligible_users | default([])) | length > 0
    - github_known_host.stdout is defined
  tags:
    - dotfiles
    - install
    - ssh

- name: Set authorized keys for all users
  ansible.builtin.authorized_key:
    user: "{{ item.0.key }}"
    state: present
    key: "{{ lookup('file', item.1) }}"
  loop: "{{ query('nested', eligible_users | default([]), local_public_keys | default([])) }}"
  become: true
  when:
    - (eligible_users | default([])) | length > 0
    - (local_public_keys | default([])) | length > 0
  tags:
    - dotfiles
    - install
    - ssh
